import React from "react";
import {
  View,
  Text,
  TouchableOpacity,
  ScrollView,
  StyleSheet,
} from "react-native";
import { ThemedText } from "@/components/ThemedText";
import { ThemedView } from "@/components/ThemedView";
import AnimatedButton from "@/components/ui/AnimatedButton";
import { COLORS, SPACING, RADIUS, SHADOWS } from "@/constants/theme";

interface FilterOption {
  label: string;
  value: string;
  count?: number;
}

interface SidebarFiltersProps {
  categorias: FilterOption[];
  marcas: FilterOption[];
  selectedCategoria: string;
  selectedMarca: string;
  selectedStock: string;
  onCategoriaChange: (value: string) => void;
  onMarcaChange: (value: string) => void;
  onStockChange: (value: string) => void;
  onClearFilters: () => void;
  onAddProduct: () => void;
  onViewInventory?: () => void;
}

const SidebarFilters: React.FC<SidebarFiltersProps> = ({
  categorias,
  marcas,
  selectedCategoria,
  selectedMarca,
  selectedStock,
  onCategoriaChange,
  onMarcaChange,
  onStockChange,
  onClearFilters,
  onAddProduct,
  onViewInventory,
}) => {
  const [categoriasCollapsed, setCategoriasCollapsed] = React.useState(false);
  const [marcasCollapsed, setMarcasCollapsed] = React.useState(false);
  const [stockCollapsed, setStockCollapsed] = React.useState(false);

  const stockOptions = [
    { label: "Disponible", value: "disponible" },
    { label: "Agotado", value: "agotado" },
  ];

  const renderFilterSection = (
    title: string,
    options: FilterOption[],
    selectedValue: string,
    onSelect: (value: string) => void,
    showAllOption = true,
    isCollapsed = false,
    toggleCollapse?: () => void
  ) => (
    <View style={styles.filterSection}>
      <TouchableOpacity 
        style={styles.sectionHeader}
        onPress={toggleCollapse}
      >
        <Text style={styles.sectionTitle}>{title}</Text>
        <Text style={styles.collapseIcon}>
          {isCollapsed ? "‚ñ∂" : "‚ñº"}
        </Text>
      </TouchableOpacity>

      {!isCollapsed && (
        <View style={styles.sectionContent}>
          {showAllOption && (
            <TouchableOpacity
              style={[
                styles.filterOption,
                selectedValue === "" && styles.filterOptionSelected,
              ]}
              onPress={() => onSelect("")}
            >
              <Text
                style={[
                  styles.filterOptionText,
                  selectedValue === "" && styles.filterOptionTextSelected,
                ]}
              >
                Todos
              </Text>
            </TouchableOpacity>
          )}

          {options.map((option) => (
            <TouchableOpacity
              key={option.value}
              style={[
                styles.filterOption,
                selectedValue === option.value && styles.filterOptionSelected,
              ]}
              onPress={() => onSelect(option.value)}
            >
              <View style={styles.filterOptionContent}>
                <Text
                  style={[
                    styles.filterOptionText,
                    selectedValue === option.value &&
                      styles.filterOptionTextSelected,
                  ]}
                >
                  {option.label}
                </Text>
                {option.count !== undefined && (
                  <Text style={styles.filterCount}>({option.count})</Text>
                )}
              </View>
            </TouchableOpacity>
          ))}
        </View>
      )}
    </View>
  );

      {showAllOption && (
        <TouchableOpacity
          style={[
            styles.filterOption,
            selectedValue === "" && styles.filterOptionSelected,
          ]}
          onPress={() => onSelect("")}
        >
          <Text
            style={[
              styles.filterOptionText,
              selectedValue === "" && styles.filterOptionTextSelected,
            ]}
          >
            Todos
          </Text>
        </TouchableOpacity>
      )}

      {options.map((option) => (
        <TouchableOpacity
          key={option.value}
          style={[
            styles.filterOption,
            selectedValue === option.value && styles.filterOptionSelected,
          ]}
          onPress={() => onSelect(option.value)}
        >
          <View style={styles.filterOptionContent}>
            <Text
              style={[
                styles.filterOptionText,
                selectedValue === option.value &&
                  styles.filterOptionTextSelected,
              ]}
            >
              {option.label}
            </Text>
            {option.count !== undefined && (
              <Text style={styles.filterCount}>({option.count})</Text>
            )}
          </View>
        </TouchableOpacity>
      ))}
    </View>
  );

  const hasActiveFilters =
    selectedCategoria !== "" || selectedMarca !== "" || selectedStock !== "";

  return (
    <ThemedView style={styles.container}>
      <ScrollView
        style={styles.scrollContainer}
        showsVerticalScrollIndicator={false}
      >
        {/* Header con t√≠tulo creativo */}
        <View style={styles.header}>
          <View style={styles.titleSection}>
            <Text style={styles.mainTitle}>üè† Hogar Conectado</Text>
            <Text style={styles.subtitle}>Gesti√≥n de Productos</Text>
          </View>
        </View>

        {/* Bot√≥n de agregar producto prominente */}
        <View style={styles.addProductSection}>
          <AnimatedButton
            title="‚ûï Agregar Producto"
            onPress={onAddProduct}
            variant="primary"
            style={styles.addProductButton}
          />

          {/* Enlace de inventario */}
          {/* Removido como solicitado */}
        </View>

        <View style={styles.divider} />

        {/* Header de filtros */}
        <View style={styles.filtersHeader}>
          <ThemedText style={styles.filtersTitle}>Filtrar Productos</ThemedText>
          {hasActiveFilters && (
            <TouchableOpacity
              onPress={onClearFilters}
              style={styles.clearButton}
            >
              <Text style={styles.clearButtonText}>Limpiar</Text>
            </TouchableOpacity>
          )}
        </View>

        {/* Categor√≠as */}
        {renderFilterSection(
          "üè∑Ô∏è Categor√≠as",
          categorias,
          selectedCategoria,
          onCategoriaChange
        )}

        <View style={styles.divider} />

        {/* Marcas */}
        {renderFilterSection("üè¢ Marcas", marcas, selectedMarca, onMarcaChange)}

        <View style={styles.divider} />

        {/* Stock */}
        {renderFilterSection(
          "üì¶ Disponibilidad",
          stockOptions,
          selectedStock,
          onStockChange,
          false // No mostrar opci√≥n "Todos" para stock
        )}
      </ScrollView>
    </ThemedView>
  );
};

const styles = StyleSheet.create({
  container: {
    width: 280,
    backgroundColor: COLORS.surface,
    borderRightWidth: 1,
    borderRightColor: COLORS.border,
    height: "100%",
  },
  scrollContainer: {
    flex: 1,
    padding: SPACING.md,
  },
  header: {
    flexDirection: "row",
    justifyContent: "space-between",
    alignItems: "center",
    marginBottom: SPACING.md,
  },
  title: {
    fontSize: 20,
    fontWeight: "600",
    color: COLORS.text,
  },
  clearButton: {
    paddingHorizontal: SPACING.sm,
    paddingVertical: SPACING.xs,
    backgroundColor: COLORS.primary,
    borderRadius: RADIUS.sm,
  },
  clearButtonText: {
    color: COLORS.surface,
    fontSize: 12,
    fontWeight: "500",
  },
  divider: {
    height: 1,
    backgroundColor: COLORS.border,
    marginVertical: SPACING.md,
  },
  filterSection: {
    marginBottom: SPACING.md,
  },
  sectionTitle: {
    fontSize: 16,
    fontWeight: "600",
    color: COLORS.text,
    marginBottom: SPACING.sm,
  },
  filterOption: {
    paddingVertical: SPACING.sm,
    paddingHorizontal: SPACING.sm,
    borderRadius: RADIUS.sm,
    marginBottom: SPACING.xs,
  },
  filterOptionSelected: {
    backgroundColor: COLORS.primary,
  },
  filterOptionContent: {
    flexDirection: "row",
    justifyContent: "space-between",
    alignItems: "center",
  },
  filterOptionText: {
    fontSize: 14,
    color: COLORS.textSecondary,
    flex: 1,
  },
  filterOptionTextSelected: {
    color: COLORS.surface,
    fontWeight: "500",
  },
  filterCount: {
    fontSize: 12,
    color: COLORS.textLight,
    marginLeft: SPACING.xs,
  },

  // Nuevos estilos para el dise√±o mejorado
  titleSection: {
    alignItems: "center" as const,
    paddingVertical: SPACING.md,
  },
  mainTitle: {
    fontSize: 18,
    fontWeight: "bold" as const,
    color: COLORS.primary,
    textAlign: "center" as const,
  },
  subtitle: {
    fontSize: 12,
    color: COLORS.textSecondary,
    textAlign: "center" as const,
    marginTop: 2,
  },
  addProductSection: {
    paddingVertical: SPACING.md,
  },
  addProductButton: {
    width: "100%" as const,
  },
  filtersHeader: {
    flexDirection: "row" as const,
    justifyContent: "space-between" as const,
    alignItems: "center" as const,
    marginBottom: SPACING.md,
  },
  filtersTitle: {
    fontSize: 16,
    fontWeight: "600" as const,
    color: COLORS.text,
  },
  inventoryLink: {
    marginTop: SPACING.md,
    paddingVertical: SPACING.sm,
    paddingHorizontal: SPACING.md,
    backgroundColor: COLORS.secondary,
    borderRadius: RADIUS.md,
    alignItems: "center" as const,
  },
  inventoryLinkText: {
    color: COLORS.text,
    fontSize: 14,
    fontWeight: "500" as const,
  },
});

export default SidebarFilters;
